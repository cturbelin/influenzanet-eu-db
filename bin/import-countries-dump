#!/bin/sh

# Restore DB tables from each country using their dump

if [ ! -f conf.sh ]; then
 echo "conf.sh file not found, are you running in root dir ?"
 exit 1
fi

. ./conf.sh

PGSQL="psql -d $DB_TARGET"

SQL_DIR="sql"
LOCAL_DIR="local"

echo $CWD

countries="nl fr es uk it pt se dk"

echo "Cleaning up DB $DB_TARGET"
$PGSQL < $SQL_DIR/import/cleanup_db.sql

for country in $countries
do
        prefix=epidb_results.custom
	file="$LOCAL_DIR/$prefix.$country"
        if [ ! -f $file ]; then
         echo "Unable to find epidb dump in local/ dir. Did you run bin/download ?"
         continue
        fi
        echo "===== Importing dump $country ===="
	if [ -f $SQL_DIR/dump/create.$country.sql ]; then
		dump="$LOCAL_DIR/$prefix.$country.clean"
		if [ -f $dump ]; then
			rm $dump
		fi
		echo "Running cleanup"
		bin/clean-dump $prefix $country
	else
	 	echo "No need to clean the dump, use the dump $file" 
		dump=$file
	fi
	if [ ! -f $dump ]; then
	  echo "ERROR: Unable to find $dump"
          exit 1	
	fi
	echo "Restoring cleaned dump for $country into $DB_TARGET from $dump"
        pg_restore -Fc -a -x -O -d $DB_TARGET $dump 
	if [ "$?" == "0" ]; then
		echo "Restoring OK"
	else
		echo "<ERROR> Unable to restore db completely"
		exit 1
	fi
done
